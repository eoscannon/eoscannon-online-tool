<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>EOS Tool  | EOSCannon 出品</title>
    <link rel="shortcut icon" type="image/x-icon" href="resource/eoscannon.ico">
    <link rel="stylesheet" href="resource/bootstrap.min.css">
</head>

<body class="container">
    <div class="text-center">
        <img height=150px src="resource/img/eoslogo.png">
    </div>
    <h1 class="text-center" style='padding-top:30px'>EOS 交易签名发送工具</h1>
    <section id="alerts">
        <div class="alert alert-warning" role="alert">
            此页面在线使用，将下方信息粘贴至离线工具中。
        </div>
    </section>
    <div class="form-group">
        <label for="eos-chain-id">
            <strong>EOS区块高度 </strong>
        </label>
        <textarea id="signed-message" class="form-control" rows="3" readonly=true></textarea>
    </div>
    <div class="form-group">
        <button id="copy" class="btn btn-success" data-clipboard-target="#signed-message">复制初始化信息|Copy inital message</button>
    </div>
    <section>
        <div class="alert alert-warning" role="alert">
            下方粘贴已签名的交易报文，并发送
        </div>
    </section>
    <div class="form-group">
        <label for="eos-chain-id">
            <strong>发送交易</strong>
        </label>
        <textarea id="send-message" class="form-control" rows="10" ></textarea>
    </div>
    <div class="form-group">
        <button id="send" class="btn btn-success" data-clipboard-target="#signed-message" onclick="sendTrasctioin()">发送已签名报文|Send signed trasaction</button>
        <!--<button id="close" class="btn btn-danger" onclick="window.close()">关闭页面|Close Page</button>-->
    </div>
    <!-- 1、引入相关的 clipboard 文件  -->
    <script src="js/clipboard.min.js"></script>
    <script src="js/eos.js" type="text/javascript"></script>
    <script type="text/javascript">
        // 2、实例化（参数内是要触发事件源对象元素）
        new Clipboard('.btn');
        let {ecc} = Eos.modules;
        let nodeAddress = 'https://mainnet.genereos.io';
        config = {
           httpEndpoint: nodeAddress,
            expireInSeconds: 60,
            chainId: 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906'
        };
        eos = Eos.Testnet(config);

        //初始化
        getInfo()
        function getBlock(data ,exp) {
            console.log('==============get block==================');
            eos.getBlock({"block_num_or_id":data}).then(( res , err)=> {
            let newData ={
                ref_block_prefix:res.ref_block_prefix,
                ref_block_num: data,
                expiration:exp
            }
             document.getElementById('signed-message').value = JSON.stringify(newData)
             });
        }
        function getInfo() {
            console.log('==============get info==================');
            eos.getInfo((err,res)=> {
                let data = res.head_block_num  - 3 & 0xFFFF;

                var exp = getExpiration(res)+""
                getBlock(data , exp)
            });
        }

        function getExpiration(info){
            var expireInSeconds = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 60;
            var chainDate = new Date(info.head_block_time + 'Z');
            var expiration = new Date(chainDate.getTime() + expireInSeconds * 1000);
            expiration = expiration.toISOString().split('.')[0]
            return expiration
        }

        //发送报文

        function sendTrasctioin(){
            var signed = document.getElementById('send-message').value;
            var content =JSON.parse(signed)
            eos.pushTransaction(content).then((res , err) => {
                console.log('res:',res);
                console.log("Err:",err);
                alert("发送成功")
             }).catch(()=>{
                alert("发送失败")
            });
        }

    </script>

</body>

</html>